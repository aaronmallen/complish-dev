#!/usr/bin/env sh
#MISE description="Lint shell files"
#MISE alias=["l:sh", "l:shell", "lint:sh", "lint:shell"]
#USAGE flag "--fix" help="Auto-fix issues where possible"

set -eu

FIX_MODE=false
while [ $# -gt 0 ]; do
  case $1 in
    --fix)
      FIX_MODE=true
      shift
      ;;
    -h | --help)
      echo "Usage: $0 [--fix]"
      echo "  --fix    Auto-fix issues where possible"
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      echo "Use --help for usage information"
      exit 1
      ;;
  esac
done

if [ "${usage_fix:-}" = "true" ]; then
  FIX_MODE=true
fi

SHELL_FILES=$(find tasks -type f -print0 |
  xargs -0 grep -l '^#!/.*sh' 2>/dev/null || true)

if [ "$FIX_MODE" = "true" ]; then
  echo "$SHELL_FILES" | xargs shfmt -w -i 2 -ci
fi

echo "$SHELL_FILES" | xargs shellcheck
